<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palworld サーバー設定ツール</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div id="app">
    <header class="app-header">
      <h1>Palworld サーバー設定ツール</h1>
      <p class="subtitle">PalWorldSettings.ini ジェネレーター（v0.7.1対応）</p>
    </header>

    <nav class="tab-nav">
      <button @click="activeTab = 'settings'" :class="{ active: activeTab === 'settings' }">設定編集</button>
      <button @click="activeTab = 'preview'" :class="{ active: activeTab === 'preview' }">設定プレビュー</button>
      <button @click="activeTab = 'export'" :class="{ active: activeTab === 'export' }">エクスポート / インポート</button>
    </nav>

    <main class="tab-content">
      <!-- Settings Tab -->
      <div v-show="activeTab === 'settings'">
        <div class="settings-toolbar">
          <button class="btn btn-danger" @click="resetToDefaults">デフォルトに戻す</button>
        </div>

        <section v-for="category in categories" :key="category.id" class="category-section">
          <div class="category-header" @click="toggleCategory(category.id)">
            <span class="category-icon">{{ category.icon }}</span>
            <span class="category-label">{{ category.label }}</span>
            <span class="category-count">{{ getCategorySettingsCount(category) }}項目</span>
            <span class="category-toggle">{{ openCategories[category.id] ? '\u25BC' : '\u25B6' }}</span>
          </div>

          <div v-show="openCategories[category.id]" class="category-body">
            <div v-for="sub in category.subgroups" :key="sub.id" class="subgroup">
              <div class="subgroup-header">{{ sub.label }}</div>
              <div v-for="key in sub.settings" :key="key" class="setting-row">
                <div class="setting-info">
                  <label :for="key" class="setting-label">{{ schema[key].label }}</label>
                  <span class="setting-key">{{ key }}</span>
                  <p v-if="schema[key].description" class="setting-desc">{{ schema[key].description }}</p>
                </div>

                <div class="setting-control">
                  <!-- Float -->
                  <template v-if="schema[key].type === 'float'">
                    <input type="number" :id="key" v-model.number="settings[key]" :step="schema[key].step"
                      :min="schema[key].min" :max="schema[key].max" class="input-number" />
                  </template>

                  <!-- Integer -->
                  <template v-else-if="schema[key].type === 'integer'">
                    <input type="number" :id="key" v-model.number="settings[key]" step="1" :min="schema[key].min"
                      :max="schema[key].max" class="input-number" />
                  </template>

                  <!-- Boolean toggle -->
                  <template v-else-if="schema[key].type === 'boolean'">
                    <label class="toggle-switch">
                      <input type="checkbox" :id="key" v-model="settings[key]" />
                      <span class="toggle-slider"></span>
                      <span class="toggle-label">{{ settings[key] ? 'True' : 'False' }}</span>
                    </label>
                  </template>

                  <!-- String -->
                  <template v-else-if="schema[key].type === 'string'">
                    <input type="text" :id="key" v-model="settings[key]" class="input-text" />
                  </template>

                  <!-- Enum -->
                  <template v-else-if="schema[key].type === 'enum'">
                    <select :id="key" v-model="settings[key]" class="input-select">
                      <option v-for="opt in schema[key].options" :key="opt" :value="opt">{{ opt }}</option>
                    </select>
                  </template>

                  <!-- Platforms (CrossplayPlatforms) -->
                  <template v-else-if="schema[key].type === 'platforms'">
                    <div class="platforms-control">
                      <label v-for="p in schema[key].platforms" :key="p" class="platform-item">
                        <input type="checkbox" :value="p" :checked="settings[key].includes(p)"
                          @change="togglePlatform(key, p)" />
                        {{ p }}
                      </label>
                    </div>
                  </template>

                  <!-- Tech list (DenyTechnologyList) -->
                  <template v-else-if="schema[key].type === 'techlist'">
                    <textarea :id="key" v-model="settings[key]" class="input-textarea"
                      placeholder="カンマ区切りでIDを入力&#10;例: PALBOX,RepairBench"></textarea>
                  </template>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Custom Settings Section -->
        <section class="category-section">
          <div class="category-header" @click="toggleCategory('custom')">
            <span class="category-icon">⚙️</span>
            <span class="category-label">カスタム設定</span>
            <span class="category-count">独自項目</span>
            <span class="category-toggle">{{ openCategories['custom'] ? '▼' : '▶' }}</span>
          </div>

          <div v-show="openCategories['custom']" class="category-body">
            <div class="subgroup">
              <div class="subgroup-header">🔧 カスタム設定項目</div>
              <div class="setting-row">
                <div class="setting-info">
                  <label for="customSettings" class="setting-label">カスタム設定</label>
                  <span class="setting-key">CustomSettings</span>
                  <p class="setting-desc">スキーマに存在しない独自の設定項目をここに追加できます。1行につき1つの設定を key=value
                    形式で記述してください。INIインポート時に未知の項目が見つかった場合、自動的にここに追加されます。</p>
                </div>
                <div class="setting-control">
                  <textarea id="customSettings" v-model="customSettings" class="input-textarea"
                    placeholder="例:&#10;bEnableUnknownFeature=&quot;True&quot;&#10;CustomParameter=123&#10;OldServerSetting=&quot;value&quot;"
                    rows="8"></textarea>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Preview Tab -->
      <div v-show="activeTab === 'preview'">
        <div class="preview-toolbar">
          <button class="btn btn-primary" @click="copyToClipboard">クリップボードにコピー</button>
          <span v-if="copySuccess" class="copy-feedback">コピーしました！</span>
        </div>
        <pre class="ini-output">{{ iniOutput }}</pre>
      </div>

      <!-- Export/Import Tab -->
      <div v-show="activeTab === 'export'">
        <section class="export-import-section">
          <h2>エクスポート</h2>
          <p>現在の設定をBASE64文字列として出力します。他のブラウザへ設定を共有できます。</p>
          <button class="btn btn-primary" @click="doExport">エクスポート</button>
          <textarea v-if="exportData" readonly class="data-textarea" :value="exportData"
            @click="selectAllText($event)"></textarea>
        </section>

        <section class="export-import-section">
          <h2>インポート</h2>
          <p>エクスポートしたBASE64文字列を貼り付けて設定を読み込みます。</p>
          <textarea v-model="importData" class="data-textarea" placeholder="BASE64文字列をここに貼り付け..."></textarea>
          <button class="btn btn-success" @click="doImport" :disabled="!importData.trim()">インポート</button>
          <p v-if="importError" class="error-msg">{{ importError }}</p>
          <p v-if="importSuccess" class="success-msg">設定をインポートしました！</p>
        </section>

        <section class="export-import-section">
          <h2>INI ファイルからインポート</h2>
          <p>既存の <code
              style="font-family:monospace;background:var(--bg-input);padding:1px 4px;border-radius:3px;">PalWorldSettings.ini</code>
            の内容を貼り付けて設定を反映させます。<br>
            「設定プレビュー」タブのINI出力をそのまま貼り付けることもできます。</p>
          <textarea v-model="iniImportData" class="data-textarea" rows="6"
            placeholder="[/Script/Pal.PalGameWorldSettings]&#10;OptionSettings=(BaseCampMaxNumInGuild=4,...) の内容を貼り付け..."></textarea>
          <button class="btn btn-success" @click="doImportIni" :disabled="!iniImportData.trim()">INI をインポート</button>
          <p v-if="iniImportError" class="error-msg">{{ iniImportError }}</p>
          <p v-if="iniImportSuccess" class="success-msg">{{ iniImportSuccessMsg }}</p>

          <!-- Display dropped items -->
          <div v-if="droppedItems.length > 0"
            style="margin-top: 1rem; padding: 1rem; background: var(--bg-input); border-radius: 8px; border-left: 4px solid #ff9800;">
            <h3 style="margin-top: 0; font-size: 1rem; color: #ff9800;">⚠️ スキップされた項目（カスタム設定に追加されました）</h3>
            <p style="font-size: 0.9rem; margin-bottom: 0.5rem;">以下の {{ droppedItems.length }}
              件の項目はスキーマに存在しないため、カスタム設定として保存されました：</p>
            <ul
              style="margin: 0.5rem 0; padding-left: 1.5rem; font-family: monospace; font-size: 0.85rem; max-height: 200px; overflow-y: auto;">
              <li v-for="(item, idx) in droppedItems" :key="idx" style="margin-bottom: 0.25rem;">
                <strong>{{ item.key }}</strong> = {{ item.value }}
              </li>
            </ul>
            <p style="font-size: 0.85rem; margin-top: 0.5rem; color: #888;">これらの設定は「設定編集」タブの「カスタム設定」セクションで編集できます。</p>
          </div>
        </section>
      </div>
    </main>

    <footer class="app-footer">
      <p>Palworld サーバー設定ツール | データはブラウザのlocalStorageに保存されます</p>
    </footer>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
  <script src="js/app.js"></script>
</body>

</html>